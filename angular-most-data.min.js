function DataTableBaseController($scope,$q,$filter,DTOptionsBuilder,DTColumnBuilder){CommonController($scope);var $svc,$rootElement=angular.element(document.querySelector(".ng-scope")),$injector=$rootElement.injector();$injector&&$injector.has("$svc")&&($svc=$injector.get("$svc"));var dtOptionsPromise=$q.defer();$scope.dtOptions=dtOptionsPromise.promise,$scope.init=function(model,view,filter,order,expand){var tableInstance,q=new ClientDataQueryable(model);q.service=$svc,filter&&(q.$filter=filter,q.prepare()),expand&&(q.$expand=expand),$scope.$on("data.filter",function(e,args){angular.isDefined(args)&&angular.isDefined(args.model)&&args.model===model&&(delete q.$prepared,q.$filter=args.filter,q.prepare(),$scope.$apply(function(){$scope.filter=args.filter}),tableInstance.ajax.reload())});var dtOptions=DTOptionsBuilder.newOptions().withFnServerData(function(sSource,aoData,fnCallback,oSettings){var skip=aoData[3].value,top=aoData[4].value,columns=angular.isArray($scope.dtColumns)?$scope.dtColumns:$scope.dtColumns.$$state.value;0==aoData[2].value.length&&order&&angular.isArray(order)&&order.forEach(function(order){if(order.name){var ix=columns.findIndex(function(y){return y.mData===order.name});ix>=0&&aoData[2].value.push({column:ix,dir:order.dir||"asc"})}});var orders=aoData[2].value,searchFor=aoData[5].value;if(delete q.$orderby,angular.isArray(orders)&&orders.forEach(function(x){var column=aoData[1].value[parseInt(x.column)];if(column){var colName2=column.data;/\./.test(column.data)&&(colName2=column.data.replace(/\./g,"/")),"desc"===x.dir?q.$orderby?q.thenByDescending(colName2):q.orderByDescending(colName2):q.$orderby?q.thenBy(colName2):q.orderBy(colName2)}}),searchFor)if(searchFor.value.length>0&&angular.isArray(columns)){for(var searchfilter,filter=[],i=0;i<columns.length;i++){var col=columns[i];if(col.bSearchable){var colName=col.mData;/\./.test(colName)&&(colName=col.mData.replace(/\./g,"/")),filter.push("indexof("+colName+",'"+searchFor.value.replace(/'/g,"''")+"') gt 0")}}searchfilter=filter.join(" or "),q.filter(searchfilter)}else delete q.$filter;"undefined"!=typeof q.$orderby&&null!=q.$orderby||$scope.dataView&&$scope.dataView.order&&(q.$orderby=$scope.dataView.order),q.skip(skip).take(top).inlineCount(!0).data().then(function(result){var res={recordsTotal:result.total,recordsFiltered:result.total,data:result.records};$scope.selected=null,delete $scope.selectedRowIndex,fnCallback(res)},function(reason){$scope.selected=null,delete $scope.selectedRowIndex,console.log(reason)})}).withOption("serverSide",!0).withTableTools().withTableToolsButtons([]).withTableToolsOption("sRowSelect","single").withTableToolsOption("sSelectedClass","selected").withTableToolsOption("fnRowSelected",function(nodes){var $table=$(nodes).closest("table").DataTable();$scope.$apply(function(){var selected=$table.row(nodes[0]).data();$scope.broadcast("item.selecting",selected),$scope.selected=$table.row(nodes[0]).data(),$scope.broadcast("item.selected",selected),$scope.selectedRowIndex=nodes[0]._DT_RowIndex})}).withOption("fnInitComplete",function(oSettings,json){if(angular.isArray(json.data)){if(tableInstance=oSettings.oInstance.DataTable(),$scope.setRowData=function(index,data){tableInstance&&tableInstance.row(index).data(data)},!/^true$/i.test(oSettings.oInstance.data("auto-select")))return;var selected=json.data[0];if("undefined"==typeof selected)return;$scope.broadcast("item.selecting",selected);try{TableTools.fnGetInstance(oSettings.oInstance[0]).s.dt.aoData[0]._DTTT_selected=!0,oSettings.oInstance.find("tbody>tr:first").toggleClass("selected"),$scope.selected=selected,$scope.broadcast("item.selected",selected),$scope.selectedRowIndex=0}catch(e){console.log("An error occured while trying to select row."),console.log(e)}}}).withTableToolsOption("fnRowDeselected",function(nodes){$scope.$apply(function(){$scope.selected=null})}).withPaginationType("full_numbers").withOption("lengthMenu",[5,10,25]).withOption("bFilter",!0).withOption("aaSorting",[]).withOption("rowCallback",function(nRow,aData,iDisplayIndex,iDisplayIndexFull){return $("td",nRow).unbind("click"),$("td",nRow).bind("click",function(e){var $table=$(e.target).closest("table").DataTable(),tableTools=TableTools.fnGetInstance($table[0]);tableTools&&tableTools.fnSelect($(e.target))}),nRow});$scope.dtOptions=dtOptions;var deferred=$q.defer(),promise=deferred.promise;$scope.dtColumns=promise,$svc.schema(model,function(err,schema){if(err)console.log(err),deferred.reject("Failed to get table columns.");else if($scope.dataView=schema.views.find(function(x){return x.name==view}),reAlign=/^left$|^center$|^right$|^justify$/i,angular.isObject($scope.dataView)){var dtColumns=[];dtColumns.name=$scope.dataView.name,$scope.dataView.fields.forEach(function(field){var column=DTColumnBuilder.newColumn(field.name).withTitle(angular.loc(field.title));angular.isDefined(field.sortable)&&(field.sortable||column.notSortable()),angular.isDefined(field.visible)&&(field.visible||column.notVisible());var cssClass=[];angular.isDefined(field.cssClass)&&cssClass.push(field.cssClass);var headerAlign=reAlign.exec(field.halign);headerAlign&&cssClass.push("dt-head-"+headerAlign[0]);var textAlign=reAlign.exec(field.align);textAlign&&cssClass.push("dt-"+textAlign[0]),cssClass.length>0&&column.withClass(cssClass.join(" "));var format=field.format,coltype=field.coltype,href=field.href;"Integer"==field.type||"Number"==field.type?column.withOption("defaultContent","0"):column.withOption("defaultContent","-"),angular.isDefined(format)?column.renderWith(function(value){for(var formats=format.split("|"),formattedValue=value,i=0;i<formats.length;i++)formattedValue=$filter(formats[i].replace(/(^\s*|\s*$)/g,""))(formattedValue);return formattedValue}):"link"===coltype&&column.renderWith(function(value,type,row){var row_href=new String(href);if(row_href)for(var re=/\{%(.*?)\}/i,match=re.exec(row_href);match;)row_href=row_href.replace(match[0],row[match[1]]),match=re.exec(row_href);return angular.format('<a href="%s">%s</a>',row_href,value)}),column.bSearchable=!0,angular.isDefined(field.searchable)&&(field.searchable||(column.bSearchable=!1)),dtColumns.push(column)}),deferred.resolve(dtColumns)}else deferred.reject("Failed to get model view.")})}}function DataTableClientController($scope,$q,$filter,DTOptionsBuilder,DTColumnBuilder){DataTableBaseController($scope,$q,$filter,DTOptionsBuilder,DTColumnBuilder);var filter,q=new ClientDataQueryable($scope.client.route.current.model);"undefined"!=typeof $scope.client.route.current.filter&&q.filter($scope.client.route.current.filter).prepare(),"undefined"!=typeof $scope.client.route.$filter&&q.filter($scope.client.route.$filter).prepare(),filter=q.toFilter(),$scope.init($scope.client.route.current.model,$scope.client.route.current.view,filter,$scope.client.route.current.order,$scope.client.route.current.expand)}function decodeURIComponentInternal(s){if("undefined"!=typeof s&&null!=s)return decodeURIComponent(s)}function DataTableVariantController($scope,$q,$filter,DTOptionsBuilder,DTColumnBuilder){DataTableBaseController($scope,$q,$filter,DTOptionsBuilder,DTColumnBuilder),$scope.$watch("options",function(value){angular.isDefined(value)&&($scope.init(value.$model,value.$view,decodeURIComponentInternal(value.$filter),decodeURIComponentInternal(value.$order),decodeURIComponentInternal(value.$expand)),$q.when($scope.dtColumns).then(function(value){$scope.dtColumns=value},function(reason){$scope.dtColumns=[]}))})}angular.module("most.data",["datatables"]).controller("DataTableVariantController",DataTableVariantController).controller("DataTableClientController",DataTableClientController);